â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ¥ CLINIC MICROSERVICES ARCHITECTURE                        â•‘
â•‘                              (Noviembre 2025)                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ğŸŒ EXTERNAL CLIENTS                                   â”‚
â”‚                   (Browser, Mobile, Desktop Applications)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     ğŸ” KEYCLOAK (Port 8082)            â”‚
        â”‚   Identity & Access Management (OIDC)  â”‚
        â”‚                                         â”‚
        â”‚  â”œâ”€ Realms: clinic                     â”‚
        â”‚  â”œâ”€ Clients: gateway, user-service    â”‚
        â”‚  â”œâ”€ Users: admin, doctor, nurse, user â”‚
        â”‚  â””â”€ Roles: ROLE_ADMIN, ROLE_USER      â”‚
        â”‚                                         â”‚
        â”‚  DB: PostgreSQL (keycloak-db)          â”‚
        â”‚  Persistent: ./keycloak-data/ (Host)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                  (1. Request + Get Token)
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    ğŸŸ¡ API GATEWAY (Port 8080)          â”‚
        â”‚   Spring Cloud Gateway + OAuth2        â”‚
        â”‚                                         â”‚
        â”‚  â”œâ”€ Route: /api/users â†’ user-service  â”‚
        â”‚  â”œâ”€ Route: /api/appointments â†’ appt   â”‚
        â”‚  â”œâ”€ OAuth2 Login (Keycloak)           â”‚
        â”‚  â””â”€ CORS Enabled                      â”‚
        â”‚                                         â”‚
        â”‚  Swagger: http://localhost:8080/...   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚
        (2a. gRPC)  â”‚                 â”‚  (2b. REST)
                    â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸŸ¢ USER SERVICE      â”‚  â”‚ ğŸ“… APPOINTMENT SVC   â”‚
        â”‚ (Port 9090)          â”‚  â”‚ (Port 8081)          â”‚
        â”‚                      â”‚  â”‚                      â”‚
        â”‚ REST Endpoints:      â”‚  â”‚ REST Endpoints:      â”‚
        â”‚ â”œâ”€ GET /users       â”‚  â”‚ â”œâ”€ GET /appts       â”‚
        â”‚ â”œâ”€ POST /users      â”‚  â”‚ â”œâ”€ POST /appts      â”‚
        â”‚ â”œâ”€ PUT /users/{id}  â”‚  â”‚ â”œâ”€ PUT /appts/{id}  â”‚
        â”‚ â””â”€ DELETE /users/{} â”‚  â”‚ â”œâ”€ DELETE /appts/{} â”‚
        â”‚                      â”‚  â”‚ â””â”€ GET /appts/my    â”‚
        â”‚ gRPC Service:        â”‚  â”‚                      â”‚
        â”‚ â””â”€ UserService      â”‚  â”‚ gRPC Service:        â”‚
        â”‚                      â”‚  â”‚ â””â”€ AppointmentSvc   â”‚
        â”‚ Security: JWT Bearer â”‚  â”‚                      â”‚
        â”‚ Swagger: :9090/...  â”‚  â”‚ Security: JWT Bearer â”‚
        â”‚                      â”‚  â”‚ Swagger: :8081/...  â”‚
        â”‚                      â”‚  â”‚                      â”‚
        â”‚ DB: PostgreSQL       â”‚  â”‚ DB: PostgreSQL       â”‚
        â”‚ Schema: clinic       â”‚  â”‚ Schema: clinic       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    (Register en Eureka)
                               â”‚
                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    ğŸ”· EUREKA SERVER (Port 8761)        â”‚
        â”‚    Service Registry & Discovery        â”‚
        â”‚                                         â”‚
        â”‚  Registered Services:                  â”‚
        â”‚  â”œâ”€ api-gateway (Port 8080)           â”‚
        â”‚  â”œâ”€ user-service (Port 9090)          â”‚
        â”‚  â””â”€ appointment-service (Port 8081)   â”‚
        â”‚                                         â”‚
        â”‚  Credentials: eureka / eureka123      â”‚
        â”‚  UI: http://localhost:8761           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           ğŸ“Š FLOW DE AUTENTICACION                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£  USER REQUEST
    Browser â†’ http://localhost:8080/api/users

2ï¸âƒ£  GATEWAY REDIRECT
    API Gateway â†’ Keycloak (OIDC Login)
    â”œâ”€ Client ID: gateway
    â””â”€ Redirect URI: http://localhost:8080/login/oauth2/code/keycloak

3ï¸âƒ£  KEYCLOAK AUTH
    User enters: testuser@clinic.com / password
    â†“
    Keycloak generates JWT Token
    â†“
    Redirect back to Gateway with code

4ï¸âƒ£  TOKEN EXCHANGE
    Gateway exchanges code for access_token
    â”œâ”€ Client: gateway
    â”œâ”€ Client Secret: kn6qXopbH5jqx26zFdyS1odEE6nVSDr4
    â””â”€ Returns: JWT Bearer Token

5ï¸âƒ£  API CALL WITH TOKEN
    curl -H "Authorization: Bearer <JWT_TOKEN>" \
         http://localhost:8080/api/users

6ï¸âƒ£  GATEWAY VALIDATES & ROUTES
    â”œâ”€ Validates JWT signature (jwk-set-uri from Keycloak)
    â”œâ”€ Extracts claims (roles, sub, etc)
    â””â”€ Forwards request to User Service / Appointment Service

7ï¸âƒ£  MICROSERVICE VALIDATES
    User Service / Appointment Service
    â”œâ”€ Validates JWT again (resource server)
    â”œâ”€ Checks authorization (@PreAuthorize)
    â””â”€ Returns data

8ï¸âƒ£  RESPONSE
    Data â†’ Gateway â†’ Client


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        ğŸ—„ï¸ BASES DE DATOS & VOLÃšMENES                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USER SERVICE DATABASE
â”œâ”€ Host: user-service-db (Docker)
â”œâ”€ Port: 5432
â”œâ”€ Database: postgres
â”œâ”€ User: postgres / clinic_password
â”œâ”€ Schema: clinic
â”œâ”€ Tables:
â”‚  â”œâ”€ users (id, nombre, apellido, correo, telefono, role, ...)
â”‚  â””â”€ Ãndices: idx_users_correo, idx_users_role
â””â”€ Volume: user_service_db_data (Docker Named Volume - Persistente)

APPOINTMENT SERVICE DATABASE
â”œâ”€ Host: appointment-service-db (Docker)
â”œâ”€ Port: 5432
â”œâ”€ Database: postgres
â”œâ”€ User: postgres / clinic_password
â”œâ”€ Schema: clinic
â”œâ”€ Tables:
â”‚  â”œâ”€ appointments (id, user_id, doctor_id, fecha, estado, ...)
â”‚  â”œâ”€ appointment_statuses (PENDING, CONFIRMED, CANCELLED, COMPLETED)
â”‚  â””â”€ Ãndices: idx_appointments_user, idx_appointments_doctor
â””â”€ Volume: appointment_service_db_data (Docker Named Volume - Persistente)

KEYCLOAK DATABASE
â”œâ”€ Host: keycloak-db (Docker)
â”œâ”€ Port: 5432
â”œâ”€ Database: keycloak
â”œâ”€ User: keycloak / keycloak_password
â”œâ”€ Storage: Realms, Clients, Users, Roles
â””â”€ Volume: ./keycloak-data/ (HOST MOUNT - Persistente en c:\...\keycloak-data\)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      ğŸ³ DOCKER NETWORK & CONTAINERS                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Network: microservices-net (bridge)
â””â”€ Todos los contenedores conectados en la misma red interna

Contenedores (8 total):
â”œâ”€ ğŸ” keycloak-db (postgres:15-alpine)
â”œâ”€ ğŸ” keycloak (quay.io/keycloak/keycloak:24.0)
â”œâ”€ ğŸ”· eureka-server (openjdk:21 + Spring Boot)
â”œâ”€ ğŸŸ¡ api-gateway (openjdk:21 + Spring Cloud Gateway)
â”œâ”€ ğŸŸ¢ user-service-db (postgres:15-alpine)
â”œâ”€ ğŸŸ¢ user-service (openjdk:21 + Spring Boot)
â”œâ”€ ğŸ“… appointment-service-db (postgres:15-alpine)
â””â”€ ğŸ“… appointment-service (openjdk:21 + Spring Boot)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ğŸ”Œ PUERTOS EXPUESTOS                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Keycloak               8082:8080    (OIDC Provider)
API Gateway            8080:8080    (Main Entry Point)
User Service           9090:9090    (REST + gRPC)
Appointment Service    8081:8081    (REST + gRPC)
Eureka Server          8761:8761    (Service Discovery)

PostgreSQL Ports (Internal - no expuesto):
  user-service-db:      5432
  appointment-service-db: 5432
  keycloak-db:          5432


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      ğŸ“¡ COMUNICACIÃ“N ENTRE SERVICIOS                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OPCIÃ“N 1: REST (SÃ­ncrono)
  API Gateway â†’ (HTTP + Bearer Token) â†’ User Service / Appointment Service

OPCIÃ“N 2: gRPC (AsÃ­ncrono + Eficiente)
  User Service â†â†’ (gRPC) â†â†’ Appointment Service
  (Ej: Appointment Service puede llamar User Service para validar usuario)

OPCIÃ“N 3: Service Discovery (Eureka)
  Todos los servicios se registran en Eureka
  â”œâ”€ Eureka proporciona URLs dinÃ¡micas
  â”œâ”€ Load balancing automÃ¡tico
  â””â”€ Health checks periÃ³dicos


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âœ… ESTADO ACTUAL (2025-11-26)                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… COMPLETADO:
  âœ“ Docker + Docker Compose (8 contenedores)
  âœ“ Keycloak (OIDC + OAuth2)
  âœ“ Spring Security (JWT + Bearer Token)
  âœ“ Eureka Server (Service Discovery)
  âœ“ API Gateway (Cloud Gateway + OAuth2)
  âœ“ User Service (REST + gRPC + JPA)
  âœ“ Appointment Service (REST + gRPC + JPA)
  âœ“ PostgreSQL (3 bases de datos)
  âœ“ Protobuf/gRPC Compilation
  âœ“ Swagger/OpenAPI
  âœ“ Maven Multi-Module Build
  âœ“ Persistent Volumes (Data no se pierde al hacer docker-compose down)
  âœ“ CORS Enabled
  âœ“ Health Checks

âš ï¸  EN PROGRESO:
  â—‹ Verificar que todos los containers se inicien correctamente
  â—‹ Probar endpoints REST
  â—‹ Probar gRPC services
  â—‹ Probar flujo de autenticaciÃ³n completo

ğŸ“‹ PRÃ“XIMOS PASOS:
  â–¡ Crear mÃ¡s servicios (clinic-service, doctor-service, etc.)
  â–¡ Implementar Circuit Breaker (Resilience4j)
  â–¡ Agregar logging centralizado (ELK Stack)
  â–¡ Implementar API Rate Limiting
  â–¡ AÃ±adir mÃ©tricas Prometheus/Grafana
  â–¡ Configurar CI/CD (GitHub Actions)
  â–¡ Desplegar a Kubernetes


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ§ª COMANDOS ÃšTILES PARA TESTING                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Ver estado de los servicios
docker-compose ps

# Ver logs de un servicio
docker logs appointment-service -f

# Obtener token de Keycloak
curl -X POST "http://localhost:8082/realms/clinic/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password&client_id=gateway&username=testuser@clinic.com&password=testuser123"

# Llamar API con token
curl -H "Authorization: Bearer <TOKEN>" http://localhost:9090/api/users

# Ver Eureka
http://localhost:8761 (eureka / eureka123)

# Ver Swagger
http://localhost:9090/swagger-ui.html (User Service)
http://localhost:8081/swagger-ui.html (Appointment Service)
http://localhost:8080/swagger-ui.html (Gateway)

# Reiniciar todos
docker-compose down
docker-compose up -d

# Reiniciar con rebuild
docker-compose down
docker-compose up -d --build
